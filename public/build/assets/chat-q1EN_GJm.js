class o{constructor(){this.baseUrl="/chat",this.csrfToken=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")}async request(e,s={}){const t={headers:{"X-CSRF-TOKEN":this.csrfToken,Accept:"application/json","Content-Type":"application/json"},credentials:"same-origin",...s};try{const a=await fetch(`${this.baseUrl}${e}`,t);return await this.handleResponse(a)}catch(a){throw this.handleError(a)}}async handleResponse(e){if(e.status===401)throw new Error("UNAUTHORIZED");if(!e.ok){const s=await e.json().catch(()=>({}));throw new Error(s.error||`HTTP ${e.status}`)}return await e.json()}handleError(e){return e.message==="UNAUTHORIZED"&&this.showLoginModal(),e}showLoginModal(){console.warn("User needs to login")}async startSession(e){return this.request("/sessions",{method:"POST",body:JSON.stringify(e)})}async sendMessage(e,s){return this.request(`/sessions/${e}/messages`,{method:"POST",body:JSON.stringify({message:s})})}async getSessions(){return this.request("/sessions")}async getSession(e){return this.request(`/sessions/${e}`)}async deleteSession(e){return this.request(`/sessions/${e}`,{method:"DELETE"})}async getUsageStats(){return this.request("/usage-stats")}async validateConnection(){try{return await this.request("/sessions"),!0}catch{throw new Error("API connection failed")}}}class g{constructor(){this.events={}}on(e,s){this.events[e]||(this.events[e]=[]),this.events[e].push(s)}emit(e,s){this.events[e]&&this.events[e].forEach(t=>{try{t(s)}catch(a){console.error(`Error in event callback for ${e}:`,a)}})}off(e,s){this.events[e]&&(this.events[e]=this.events[e].filter(t=>t!==s))}removeAllListeners(e){e?delete this.events[e]:this.events={}}}class c{constructor(e){this.chatSystem=e,this.sessions=[]}async startSession(e){if(!this.chatSystem.isLoading)try{this.chatSystem.isLoading=!0,this.chatSystem.uiManager.showLoading("Membuat sesi baru...");const s=await this.chatSystem.apiService.startSession(e);s.success&&(this.chatSystem.currentSessionId=s.data.session.session_id,this.chatSystem.uiManager.updateSessionInfo(s.data.session),this.chatSystem.uiManager.showChatInterface(),s.data.initial_response&&this.chatSystem.messageHandler.addMessage("assistant",s.data.initial_response.content,s.data.initial_response.created_at),this.chatSystem.analyticsTracker.trackSessionStart(e),this.chatSystem.uiManager.showNotification("Sesi berhasil dibuat","success"))}catch(s){this.chatSystem.uiManager.showError("Gagal membuat sesi: "+s.message)}finally{this.chatSystem.isLoading=!1,this.chatSystem.uiManager.hideLoading()}}async loadSession(e){try{this.chatSystem.uiManager.showLoading("Memuat sesi...");const s=await this.chatSystem.apiService.getSession(e);s.success&&(this.chatSystem.currentSessionId=e,this.chatSystem.uiManager.updateSessionInfo(s.data),this.chatSystem.uiManager.showChatInterface(),this.chatSystem.uiManager.loadMessages(s.data.messages),this.chatSystem.uiManager.hideSessionsModal())}catch(s){this.chatSystem.uiManager.showError("Gagal memuat sesi: "+s.message)}finally{this.chatSystem.uiManager.hideLoading()}}async deleteSession(e){if(confirm("Apakah Anda yakin ingin menghapus sesi ini?"))try{await this.chatSystem.apiService.deleteSession(e),e===this.chatSystem.currentSessionId&&this.chatSystem.uiManager.showNewSessionForm(),this.chatSystem.uiManager.showNotification("Sesi berhasil dihapus","success")}catch(s){this.chatSystem.uiManager.showError("Gagal menghapus sesi: "+s.message)}}async loadAnimalTypes(){try{const s=await(await fetch("/api/animal-types")).json();this.chatSystem.uiManager.populateAnimalTypes(s.data||s)}catch(e){console.error("Error loading animal types:",e),this.chatSystem.uiManager.populateAnimalTypes(this.getDefaultAnimalTypes())}}getDefaultAnimalTypes(){return[{id:1,name:"Ayam Broiler"},{id:2,name:"Ayam Petelur"},{id:3,name:"Sapi Potong"},{id:4,name:"Sapi Perah"},{id:5,name:"Kambing"},{id:6,name:"Domba"}]}}class h{constructor(e){this.chatSystem=e}async sendMessage(e){if(!e.trim()||!this.chatSystem.currentSessionId){this.chatSystem.uiManager.showWarning("Silakan mulai sesi chat terlebih dahulu");return}this.addMessage("user",e),this.chatSystem.uiManager.clearMessageInput(),this.chatSystem.isFirstMessage&&(this.chatSystem.uiManager.hideQuickQuestions(),this.chatSystem.isFirstMessage=!1);const s=this.chatSystem.uiManager.createMessageElement("assistant","",new Date().toISOString());this.chatSystem.uiManager.appendMessage(s),this.chatSystem.uiManager.scrollToBottom();const t=s.querySelector(".message-text");try{const a=await this.chatSystem.apiService.sendMessage(this.chatSystem.currentSessionId,e);if(a.success){await this.streamText(t,a.data.ai_response.content);const i=s.querySelector(".message-time");i.textContent=this.chatSystem.uiManager.formatTimestamp(new Date().toISOString()),this.chatSystem.analyticsTracker.trackMessageSent(e,"success")}else await this.streamText(t,`Maaf, terjadi kesalahan: ${a.error||"Unknown error"}. Silakan coba lagi.`),this.chatSystem.analyticsTracker.trackMessageSent(e,"error")}catch(a){await this.streamText(t,`Maaf, terjadi kesalahan: ${a.message}. Silakan coba lagi.`),this.chatSystem.analyticsTracker.trackMessageSent(e,"error")}}addMessage(e,s,t=null){const a=this.chatSystem.uiManager.createMessageElement(e,s,t);this.chatSystem.uiManager.appendMessage(a),this.chatSystem.uiManager.scrollToBottom()}formatMessage(e){return e=e.replace(/\n{3,}/g,`

`),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/__(.*?)__/g,"<u>$1</u>").replace(/`(.*?)`/g,"<code>$1</code>"),e=e.replace(/\n/g,"<br>"),e=e.replace(/^\* (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>"),e=e.replace(/(<li>.*<\/li>\s*)+/g,"<ul>$&</ul>"),e=e.replace(/^### (.*$)/gm,"<h4>$1</h4>").replace(/^## (.*$)/gm,"<h3>$1</h3>").replace(/^# (.*$)/gm,"<h2>$1</h2>"),e=e.replace(/<br><br><br>/g,"<br><br>"),e}async streamText(e,s){const t=s.split(" ");let a="";for(let i=0;i<t.length;i++)a+=t[i]+" ",e.innerHTML=this.formatMessage(a.trim()),this.chatSystem.uiManager.scrollToBottom(),await new Promise(r=>setTimeout(r,50));e.innerHTML=this.formatMessage(s)}}class l{constructor(e){this.chatSystem=e,this.elements=this.initializeElements()}initializeElements(){return{chatContainer:document.getElementById("chatContainer"),newSessionForm:document.getElementById("newSessionForm"),messageInput:document.getElementById("messageInput"),messagesList:document.getElementById("messagesList"),loadingIndicator:document.getElementById("loadingIndicator"),sessionInfo:document.getElementById("sessionInfo"),quickQuestions:document.getElementById("quickQuestions"),messageInputField:document.getElementById("messageInputField"),sessionsModal:document.getElementById("sessionsModal"),statsModal:document.getElementById("statsModal"),sessionTitle:document.getElementById("sessionTitle"),sessionAnimal:document.getElementById("sessionAnimal")}}showWelcomeScreen(){this.elements.newSessionForm.style.display="flex",this.elements.chatContainer.style.display="none",this.elements.messageInput.style.display="none",this.elements.sessionInfo.style.display="none"}showChatInterface(){this.elements.newSessionForm.style.display="none",this.elements.chatContainer.style.display="flex",this.elements.messageInput.style.display="block",this.elements.sessionInfo.style.display="block",this.elements.quickQuestions.style.display="block"}showNewSessionForm(){this.chatSystem.currentSessionId=null,this.chatSystem.isFirstMessage=!0,this.showWelcomeScreen()}updateSessionInfo(e){this.elements.sessionTitle.textContent=e.title,this.elements.sessionAnimal.textContent=`Jenis Ternak: ${e.animal_type?.name||"Tidak ditentukan"}`}showTypingIndicator(){this.elements.loadingIndicator&&(this.elements.loadingIndicator.style.display="block",this.scrollToBottom())}hideTypingIndicator(){this.elements.loadingIndicator&&(this.elements.loadingIndicator.style.display="none")}createMessageElement(e,s,t=null){const i=document.getElementById(e==="user"?"userMessageTemplate":"aiMessageTemplate").content.cloneNode(!0),r=i.querySelector(".message-text");if(r.innerHTML=this.formatMessage(s),t){const m=i.querySelector(".message-time");m.textContent=this.formatTimestamp(t)}return i}appendMessage(e){const s=document.getElementById("messagesContainer");s&&s.appendChild(e)}scrollToBottom(){const e=document.getElementById("chatMessages");e&&(e.scrollTop=e.scrollHeight)}clearMessageInput(){this.elements.messageInputField&&(this.elements.messageInputField.value="")}formatMessage(e){return e.replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>")}formatTimestamp(e){return new Date(e).toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"})}showError(e){console.error(e)}showWarning(e){console.warn(e)}hideQuickQuestions(){this.elements.quickQuestions&&(this.elements.quickQuestions.style.display="none")}}class d{constructor(e){this.chatSystem=e}trackSessionStart(e){console.log("Session started:",e)}trackMessageSent(e,s){console.log("Message sent:",{message:e,status:s})}trackSessionLoad(e){console.log("Session loaded:",e)}trackError(e,s){console.error("Error tracked:",{error:e,context:s})}}class u{constructor(){this.currentSessionId=null,this.isFirstMessage=!0,this.isLoading=!1,this.apiService=new o,this.eventManager=new g,this.sessionManager=new c(this),this.messageHandler=new h(this),this.uiManager=new l(this),this.analyticsTracker=new d(this),this.init()}async init(){try{await this.loadDependencies(),this.setupEventListeners(),await this.loadInitialData(),this.uiManager.showChatInterface()}catch(e){console.error("Failed to initialize chat system:",e),this.uiManager.showError("Gagal memuat sistem chat")}}async loadDependencies(){await this.apiService.validateConnection()}setupEventListeners(){this.eventManager.on("session:start",e=>this.sessionManager.startSession(e)),this.eventManager.on("session:load",e=>this.sessionManager.loadSession(e)),this.eventManager.on("session:delete",e=>this.sessionManager.deleteSession(e)),this.eventManager.on("message:send",e=>this.messageHandler.sendMessage(e)),this.eventManager.on("ui:showSessions",()=>this.uiManager.showSessionsModal()),this.eventManager.on("ui:showStats",()=>this.uiManager.showStatsModal())}async loadInitialData(){await this.sessionManager.loadAnimalTypes()}startNewSession(e){this.eventManager.emit("session:start",e)}sendUserMessage(e){this.eventManager.emit("message:send",e)}loadChatSession(e){this.eventManager.emit("session:load",e)}}document.addEventListener("DOMContentLoaded",function(){try{window.apiService=new o,window.chatSystem=new u,window.messageHandler=new h(window.chatSystem),window.sessionManager=new c(window.chatSystem),window.uiManager=new l(window.chatSystem),window.chatSystem.init(),console.log("Chat system initialized successfully")}catch(n){console.error("Failed to initialize chat system:",n),console.warn("Using fallback chat functionality")}});
